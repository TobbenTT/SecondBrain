# SecondBrain â€” Staging Environment
# Uso: docker compose -f docker-compose.staging.yml up -d --build
#
# Corre en paralelo con produccion sin interferir.
# Puertos: dashboard=3010, correos=3013 (produccion usa 3000/3003)
# Volumenes separados: staging-data, staging-correos-data
# Knowledge separado: ./knowledge-staging (no toca produccion)

services:
  dashboard-staging:
    build: ./apps/dashboard
    container_name: staging-dashboard
    restart: unless-stopped
    ports:
      - "3010:3010"
    env_file:
      - ./apps/dashboard/.env.staging
    environment:
      - PORT=3010
      - NODE_ENV=staging
      - OLLAMA_URL=http://host.docker.internal:11434
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3}
      - OLLAMA_TIMEOUT=120000
      - OLLAMA_CTX=4096
      - OLLAMA_TEMP=0.3
      - OLLAMA_KEEP_ALIVE=10m
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - staging-data:/app/data
      - ./knowledge-staging:/knowledge
      - ./core/skills:/core/skills
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3010/health"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
    depends_on:
      ollama-pull-staging:
        condition: service_completed_successfully

  inteligencia-correos-staging:
    build: ./Inteligencia-de-correos
    container_name: staging-correos
    restart: unless-stopped
    ports:
      - "3013:3013"
    env_file:
      - ./Inteligencia-de-correos/.env.staging
    environment:
      - PORT=3013
      - DASHBOARD_URL=http://dashboard-staging:3010
    volumes:
      - staging-correos-data:/app/repositorio_reuniones
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3013/health"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
    depends_on:
      dashboard-staging:
        condition: service_healthy

  # Reutiliza el mismo Ollama del host (read-only, no conflicto)
  ollama-pull-staging:
    image: curlimages/curl:latest
    container_name: staging-ollama-pull
    extra_hosts:
      - "host.docker.internal:host-gateway"
    entrypoint: >
      sh -c '
        echo "Staging: Checking Ollama..."
        if curl -sf http://host.docker.internal:11434/api/tags > /dev/null 2>&1; then
          echo "Ollama available for staging."
        else
          echo "WARNING: Ollama not running. Staging will use Gemini fallback."
        fi
        echo "Done."
      '
    restart: "no"

volumes:
  staging-data:
  staging-correos-data:
