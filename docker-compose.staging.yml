# SecondBrain â€” Staging Environment
# Uso: docker compose -f docker-compose.staging.yml up -d --build
#
# Corre en paralelo con produccion sin interferir.
# Puertos: dashboard=3010, correos=3013, postgres=5433 (produccion usa 3000/3003)
# Volumenes separados: staging-data, staging-correos-data, staging-pg-data
# Knowledge separado: ./knowledge-staging (no toca produccion)

services:
  redis-staging:
    image: redis:7-alpine
    container_name: staging-redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - staging-redis-data:/data

  postgres-staging:
    image: postgres:16-alpine
    container_name: staging-postgres
    restart: unless-stopped
    ports:
      - "5433:5432"
    environment:
      POSTGRES_USER: secondbrain
      POSTGRES_PASSWORD: ${PG_PASSWORD:-staging_sb_2026}
      POSTGRES_DB: secondbrain
    volumes:
      - staging-pg-data:/var/lib/postgresql/data
      - ./scripts/init-pg.sql:/docker-entrypoint-initdb.d/01-schema.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U secondbrain"]
      interval: 10s
      timeout: 5s
      retries: 5

  dashboard-staging:
    build: ./apps/dashboard
    container_name: staging-dashboard
    restart: unless-stopped
    ports:
      - "3010:3010"
    env_file:
      - ./apps/dashboard/.env.staging
    environment:
      - PORT=3010
      - NODE_ENV=staging
      - PG_HOST=postgres-staging
      - PG_PORT=5432
      - PG_USER=secondbrain
      - PG_PASSWORD=${PG_PASSWORD:-staging_sb_2026}
      - PG_DATABASE=secondbrain
      - OLLAMA_URL=http://host.docker.internal:11434
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3}
      - OLLAMA_TIMEOUT=120000
      - OLLAMA_CTX=4096
      - OLLAMA_TEMP=0.3
      - OLLAMA_KEEP_ALIVE=10m
      - REDIS_HOST=redis-staging
      - REDIS_PORT=6379
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - staging-data:/app/data
      - staging-avatars:/app/public/avatars
      - staging-gallery:/app/public/gallery
      - staging-voicenotes:/app/public/voice-notes
      - ./knowledge-staging:/knowledge
      - ./core/skills:/core/skills
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3010/health"]
      interval: 30s
      timeout: 5s
      start_period: 15s
      retries: 3
    depends_on:
      redis-staging:
        condition: service_healthy
      postgres-staging:
        condition: service_healthy

  inteligencia-correos-staging:
    build: ./Inteligencia-de-correos
    container_name: staging-correos
    restart: unless-stopped
    ports:
      - "3013:3013"
    env_file:
      - ./Inteligencia-de-correos/.env.staging
    environment:
      - PORT=3013
      - DASHBOARD_URL=http://dashboard-staging:3010
      - DB_HOST=postgres-staging
      - DB_PORT=5432
      - DB_USER=secondbrain
      - DB_PASSWORD=${PG_PASSWORD:-staging_sb_2026}
      - DB_NAME=secondbrain
      - DB_SSL=false
    volumes:
      - staging-correos-data:/app/repositorio_reuniones
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3013/health"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
    depends_on:
      postgres-staging:
        condition: service_healthy
      dashboard-staging:
        condition: service_healthy

  # Reutiliza el mismo Ollama del host (read-only, no conflicto)
  ollama-pull-staging:
    image: curlimages/curl:latest
    container_name: staging-ollama-pull
    extra_hosts:
      - "host.docker.internal:host-gateway"
    entrypoint: >
      sh -c '
        echo "Staging: Checking Ollama..."
        if curl -sf http://host.docker.internal:11434/api/tags > /dev/null 2>&1; then
          echo "Ollama available for staging."
        else
          echo "WARNING: Ollama not running. Staging will use Gemini fallback."
        fi
        echo "Done."
      '
    restart: "no"

volumes:
  staging-redis-data:
  staging-data:
  staging-avatars:
  staging-gallery:
  staging-voicenotes:
  staging-correos-data:
  staging-pg-data:
