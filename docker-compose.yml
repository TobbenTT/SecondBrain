services:
  dashboard:
    build: ./apps/dashboard
    container_name: secondbrain-dashboard
    restart: unless-stopped
    ports:
      - "3000:3000"
    env_file:
      - ./apps/dashboard/.env
    environment:
      # Ollama runs on host, Docker container reaches it via host.docker.internal
      - OLLAMA_URL=http://host.docker.internal:11434
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3}
      - OLLAMA_TIMEOUT=120000
      - OLLAMA_CTX=4096
      - OLLAMA_TEMP=0.3
      - OLLAMA_KEEP_ALIVE=10m
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - sb-data:/app/data
      - ./knowledge:/knowledge
      - ./core/skills:/core/skills
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
    depends_on:
      ollama-pull:
        condition: service_completed_successfully

  # One-shot service: pulls the Ollama model if not already present
  ollama-pull:
    image: curlimages/curl:latest
    container_name: secondbrain-ollama-pull
    extra_hosts:
      - "host.docker.internal:host-gateway"
    entrypoint: >
      sh -c '
        echo "Checking Ollama at host.docker.internal:11434..."
        if curl -sf http://host.docker.internal:11434/api/tags > /dev/null 2>&1; then
          echo "Ollama is running. Checking model ${OLLAMA_MODEL:-llama3}..."
          MODELS=$(curl -sf http://host.docker.internal:11434/api/tags | grep -o "\"name\":\"[^\"]*\"" || true)
          if echo "$MODELS" | grep -q "${OLLAMA_MODEL:-llama3}"; then
            echo "Model ${OLLAMA_MODEL:-llama3} already present."
          else
            echo "Pulling model ${OLLAMA_MODEL:-llama3}... (this may take a few minutes)"
            curl -sf -X POST http://host.docker.internal:11434/api/pull -d "{\"name\":\"${OLLAMA_MODEL:-llama3}\"}" || echo "Pull failed, will use Gemini fallback"
          fi
        else
          echo "WARNING: Ollama not running on host. AI will use Gemini fallback."
          echo "Install Ollama: curl -fsSL https://ollama.com/install.sh | sh"
        fi
        echo "Done."
      '
    restart: "no"

volumes:
  sb-data:
