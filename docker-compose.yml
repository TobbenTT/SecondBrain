services:
  redis:
    image: redis:7-alpine
    container_name: secondbrain-redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - sb-redis-data:/data

  postgres:
    image: postgres:16-alpine
    container_name: secondbrain-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: secondbrain
      POSTGRES_PASSWORD: ${PG_PASSWORD:-vsc_prod_2026}
      POSTGRES_DB: secondbrain
    volumes:
      - sb-pg-data:/var/lib/postgresql/data
      - ./scripts/init-pg.sql:/docker-entrypoint-initdb.d/01-schema.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U secondbrain"]
      interval: 10s
      timeout: 5s
      retries: 5

  dashboard:
    build: ./apps/dashboard
    container_name: secondbrain-dashboard
    restart: unless-stopped
    ports:
      - "3000:3000"
    env_file:
      - ./apps/dashboard/.env
    environment:
      - NODE_ENV=production
      - PG_HOST=postgres
      - PG_PORT=5432
      - PG_USER=secondbrain
      - PG_PASSWORD=${PG_PASSWORD:-vsc_prod_2026}
      - PG_DATABASE=secondbrain
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # Ollama runs on host, Docker container reaches it via host.docker.internal
      - OLLAMA_URL=http://host.docker.internal:11434
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3}
      - OLLAMA_TIMEOUT=120000
      - OLLAMA_CTX=4096
      - OLLAMA_TEMP=0.3
      - OLLAMA_KEEP_ALIVE=10m
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - sb-data:/app/data
      - sb-avatars:/app/public/avatars
      - sb-gallery:/app/public/gallery
      - sb-voicenotes:/app/public/voice-notes
      - ./knowledge:/knowledge
      - ./core/skills:/core/skills
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 5s
      start_period: 15s
      retries: 3
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy

  # Email intelligence service: processes Fireflies webhooks, sends reports
  inteligencia-correos:
    build: ./Inteligencia-de-correos
    container_name: secondbrain-correos
    restart: unless-stopped
    ports:
      - "3003:3003"
    env_file:
      - ./Inteligencia-de-correos/.env
    environment:
      - DASHBOARD_URL=http://dashboard:3000
    volumes:
      - correos-data:/app/repositorio_reuniones
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3003/health"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
    depends_on:
      dashboard:
        condition: service_healthy

  # One-shot service: pulls the Ollama model if not already present
  ollama-pull:
    image: curlimages/curl:latest
    container_name: secondbrain-ollama-pull
    extra_hosts:
      - "host.docker.internal:host-gateway"
    entrypoint: >
      sh -c '
        echo "Checking Ollama at host.docker.internal:11434..."
        if curl -sf http://host.docker.internal:11434/api/tags > /dev/null 2>&1; then
          echo "Ollama is running. Checking model ${OLLAMA_MODEL:-llama3}..."
          MODELS=$(curl -sf http://host.docker.internal:11434/api/tags | grep -o "\"name\":\"[^\"]*\"" || true)
          if echo "$MODELS" | grep -q "${OLLAMA_MODEL:-llama3}"; then
            echo "Model ${OLLAMA_MODEL:-llama3} already present."
          else
            echo "Pulling model ${OLLAMA_MODEL:-llama3}... (this may take a few minutes)"
            curl -sf -X POST http://host.docker.internal:11434/api/pull -d "{\"name\":\"${OLLAMA_MODEL:-llama3}\"}" || echo "Pull failed, will use Gemini fallback"
          fi
        else
          echo "WARNING: Ollama not running on host. AI will use Gemini fallback."
          echo "Install Ollama: curl -fsSL https://ollama.com/install.sh | sh"
        fi
        echo "Done."
      '
    restart: "no"

volumes:
  sb-redis-data:
  sb-pg-data:
  sb-data:
  sb-avatars:
  sb-gallery:
  sb-voicenotes:
  correos-data:
